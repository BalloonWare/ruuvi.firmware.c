
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>app_sensor.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;app_config.h&quot;</a>
<a name="ln2">#include &quot;app_sensor.h&quot;</a>
<a name="ln3">#include &quot;app_comms.h&quot;</a>
<a name="ln4">#include &quot;app_heartbeat.h&quot;</a>
<a name="ln5">#include &quot;app_log.h&quot;</a>
<a name="ln6">#include &quot;ruuvi_boards.h&quot;</a>
<a name="ln7">#include &quot;ruuvi_driver_error.h&quot;</a>
<a name="ln8">#include &quot;ruuvi_driver_sensor.h&quot;</a>
<a name="ln9">#include &quot;ruuvi_endpoints.h&quot;</a>
<a name="ln10">#include &quot;ruuvi_interface_adc_ntc.h&quot;</a>
<a name="ln11">#include &quot;ruuvi_interface_adc_photo.h&quot;</a>
<a name="ln12">#include &quot;ruuvi_interface_bme280.h&quot;</a>
<a name="ln13">#include &quot;ruuvi_interface_communication_radio.h&quot;</a>
<a name="ln14">#include &quot;ruuvi_interface_dps310.h&quot;</a>
<a name="ln15">#include &quot;ruuvi_interface_gpio.h&quot;</a>
<a name="ln16">#include &quot;ruuvi_interface_gpio_interrupt.h&quot;</a>
<a name="ln17">#include &quot;ruuvi_interface_i2c.h&quot;</a>
<a name="ln18">#include &quot;ruuvi_interface_lis2dh12.h&quot;</a>
<a name="ln19">#include &quot;ruuvi_interface_log.h&quot;</a>
<a name="ln20">#include &quot;ruuvi_interface_rtc.h&quot;</a>
<a name="ln21">#include &quot;ruuvi_interface_shtcx.h&quot;</a>
<a name="ln22">#include &quot;ruuvi_interface_spi.h&quot;</a>
<a name="ln23">#include &quot;ruuvi_interface_yield.h&quot;</a>
<a name="ln24">#include &quot;ruuvi_task_adc.h&quot;</a>
<a name="ln25">#include &quot;ruuvi_task_sensor.h&quot;</a>
<a name="ln26"> </a>
<a name="ln27">#include &lt;stdio.h&gt;</a>
<a name="ln28">#include &lt;string.h&gt;</a>
<a name="ln29"> </a>
<a name="ln30">static inline void LOG (const char * const msg)</a>
<a name="ln31">{</a>
<a name="ln32">    ri_log (RI_LOG_LEVEL_INFO, msg);</a>
<a name="ln33">}</a>
<a name="ln34"> </a>
<a name="ln35">static inline void LOGD (const char * const msg)</a>
<a name="ln36">{</a>
<a name="ln37">    ri_log (RI_LOG_LEVEL_DEBUG, msg);</a>
<a name="ln38">}</a>
<a name="ln39">/**</a>
<a name="ln40"> * @addtogroup app_sensor</a>
<a name="ln41"> */</a>
<a name="ln42">/** @{ */</a>
<a name="ln43">/**</a>
<a name="ln44"> * @file app_sensor.c</a>
<a name="ln45"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln46"> * @date 2020-04-16</a>
<a name="ln47"> * @copyright Ruuvi Innovations Ltd, license BSD-3-Clause.</a>
<a name="ln48"> *</a>
<a name="ln49"> * Initialize, configure and use sensors on board.</a>
<a name="ln50"> *</a>
<a name="ln51"> * Typical usage:</a>
<a name="ln52"> *</a>
<a name="ln53"> * @code{.c}</a>
<a name="ln54"> * TODO</a>
<a name="ln55"> * @endcode</a>
<a name="ln56"> */</a>
<a name="ln57"> </a>
<a name="ln58">#ifndef CEEDLING</a>
<a name="ln59">static</a>
<a name="ln60">#endif</a>
<a name="ln61">rt_sensor_ctx_t * m_sensors[SENSOR_COUNT]; //!&lt; Sensor APIs.</a>
<a name="ln62">static uint64_t vdd_update_time;              //!&lt; timestamp of VDD update.</a>
<a name="ln63">static uint32_t</a>
<a name="ln64">m_event_counter;              //!&lt; Number of events registered in app_sensor.</a>
<a name="ln65"> </a>
<a name="ln66">/**</a>
<a name="ln67"> * @brief Sensor operation, such as read or configure.</a>
<a name="ln68"> *</a>
<a name="ln69"> * These are used when outside central commands sensor to e.g. configure a sensor</a>
<a name="ln70"> * or read log. Operations are targeted on specific data types, such as</a>
<a name="ln71"> * temperature or acceleration. The operation is execcuted on first</a>
<a name="ln72"> * provider of given data if applicable.</a>
<a name="ln73"> *</a>
<a name="ln74"> * @param[in] reply_fp A function to which send operation acknowledgement.</a>
<a name="ln75"> * @param[in] fields Affected fields.</a>
<a name="ln76"> * @param[in] raw_message Original message triggering operation.</a>
<a name="ln77"> */</a>
<a name="ln78">typedef rd_status_t (*sensor_op) (const ri_comm_xfer_fp_t reply_fp,</a>
<a name="ln79">                                  const rd_sensor_data_fields_t fields,</a>
<a name="ln80">                                  const uint8_t * const raw_message);</a>
<a name="ln81"> </a>
<a name="ln82">#if APP_SENSOR_BME280_ENABLED</a>
<a name="ln83">static rt_sensor_ctx_t bme280 = APP_SENSOR_BME280_DEFAULT_CFG;</a>
<a name="ln84">#endif</a>
<a name="ln85"> </a>
<a name="ln86">#if APP_SENSOR_DPS310_ENABLED</a>
<a name="ln87">static rt_sensor_ctx_t dps310 = APP_SENSOR_DPS310_DEFAULT_CFG;</a>
<a name="ln88">#endif</a>
<a name="ln89"> </a>
<a name="ln90">#if APP_SENSOR_LIS2DH12_ENABLED</a>
<a name="ln91">static rt_sensor_ctx_t lis2dh12 = APP_SENSOR_LIS2DH12_DEFAULT_CFG;</a>
<a name="ln92">#endif</a>
<a name="ln93"> </a>
<a name="ln94">#if APP_SENSOR_LIS2DW12_ENABLED</a>
<a name="ln95">static rt_sensor_ctx_t lis2dw12 = APP_SENSOR_LIS2DW2_DEFAULT_CFG;</a>
<a name="ln96">#endif</a>
<a name="ln97"> </a>
<a name="ln98">#if APP_SENSOR_SHTCX_ENABLED</a>
<a name="ln99">static rt_sensor_ctx_t shtcx = APP_SENSOR_SHTCX_DEFAULT_CFG;</a>
<a name="ln100">#endif</a>
<a name="ln101"> </a>
<a name="ln102">#if APP_SENSOR_TMP117_ENABLED</a>
<a name="ln103">static rt_sensor_ctx_t tmp117 = APP_SENSOR_TMP117_DEFAULT_CFG;</a>
<a name="ln104">#endif</a>
<a name="ln105"> </a>
<a name="ln106">#if APP_SENSOR_PHOTO_ENABLED</a>
<a name="ln107">static rt_sensor_ctx_t photo = APP_SENSOR_PHOTO_DEFAULT_CFG;</a>
<a name="ln108">#endif</a>
<a name="ln109"> </a>
<a name="ln110">#if APP_SENSOR_NTC_ENABLED</a>
<a name="ln111">static rt_sensor_ctx_t ntc = APP_SENSOR_NTC_DEFAULT_CFG;</a>
<a name="ln112">#endif</a>
<a name="ln113"> </a>
<a name="ln114">#if APP_SENSOR_ENVIRONMENTAL_MCU_ENABLED</a>
<a name="ln115">static rt_sensor_ctx_t env_mcu = APP_SENSOR_ENVIRONMENTAL_MCU_DEFAULT_CFG;</a>
<a name="ln116">#endif</a>
<a name="ln117"> </a>
<a name="ln118">/** @brief Initialize sensor pointer array */</a>
<a name="ln119">#ifndef CEEDLING</a>
<a name="ln120">static</a>
<a name="ln121">#endif</a>
<a name="ln122">void</a>
<a name="ln123">m_sensors_init (void)</a>
<a name="ln124">{</a>
<a name="ln125">#if APP_SENSOR_TMP117_ENABLED</a>
<a name="ln126">    m_sensors[TMP117_INDEX] = &amp;tmp117;</a>
<a name="ln127">#endif</a>
<a name="ln128">#if APP_SENSOR_SHTCX_ENABLED</a>
<a name="ln129">    m_sensors[SHTCX_INDEX] = &amp;shtcx;</a>
<a name="ln130">#endif</a>
<a name="ln131">#if APP_SENSOR_DPS310_ENABLED</a>
<a name="ln132">    m_sensors[DPS310_INDEX] = &amp;dps310;</a>
<a name="ln133">#endif</a>
<a name="ln134">#if APP_SENSOR_BME280_ENABLED</a>
<a name="ln135">    m_sensors[BME280_INDEX] = &amp;bme280;</a>
<a name="ln136">#endif</a>
<a name="ln137">#if APP_SENSOR_NTC_ENABLED</a>
<a name="ln138">    m_sensors[NTC_INDEX] = &amp;ntc;</a>
<a name="ln139">#endif</a>
<a name="ln140">#if APP_SENSOR_PHOTO_ENABLED</a>
<a name="ln141">    m_sensors[PHOTO_INDEX] = &amp;photo;</a>
<a name="ln142">#endif</a>
<a name="ln143">#if APP_SENSOR_ENVIRONMENTAL_MCU_ENABLED</a>
<a name="ln144">    m_sensors[ENV_MCU_INDEX] = &amp;env_mcu;</a>
<a name="ln145">#endif</a>
<a name="ln146">#if APP_SENSOR_LIS2DH12_ENABLED</a>
<a name="ln147">    m_sensors[LIS2DH12_INDEX] = &amp;lis2dh12;</a>
<a name="ln148">#endif</a>
<a name="ln149">#if APP_SENSOR_LIS2DW12_ENABLED</a>
<a name="ln150">    m_sensors[LIS2DW12_INDEX] = lis2dw12;</a>
<a name="ln151">#endif</a>
<a name="ln152">}</a>
<a name="ln153"> </a>
<a name="ln154">void app_sensor_vdd_measure_isr (const ri_radio_activity_evt_t evt)</a>
<a name="ln155">{</a>
<a name="ln156">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln157"> </a>
<a name="ln158">    if (vdd_update_time &lt; ri_rtc_millis())</a>
<a name="ln159">    {</a>
<a name="ln160">        if (RI_RADIO_BEFORE == evt)</a>
<a name="ln161">        {</a>
<a name="ln162">            rd_sensor_configuration_t configuration =</a>
<a name="ln163">            {</a>
<a name="ln164">                .dsp_function = RD_SENSOR_CFG_DEFAULT,</a>
<a name="ln165">                .dsp_parameter = RD_SENSOR_CFG_DEFAULT,</a>
<a name="ln166">                .mode = RD_SENSOR_CFG_SINGLE,</a>
<a name="ln167">                .resolution = RD_SENSOR_CFG_DEFAULT,</a>
<a name="ln168">                .samplerate = RD_SENSOR_CFG_DEFAULT,</a>
<a name="ln169">                .scale = RD_SENSOR_CFG_DEFAULT</a>
<a name="ln170">            };</a>
<a name="ln171">            err_code |= rt_adc_vdd_prepare (&amp;configuration);</a>
<a name="ln172">            RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln173">        }</a>
<a name="ln174">        else</a>
<a name="ln175">        {</a>
<a name="ln176">            if (true == rt_adc_is_init())</a>
<a name="ln177">            {</a>
<a name="ln178">                vdd_update_time = ri_rtc_millis();</a>
<a name="ln179">                vdd_update_time += APP_BATTERY_SAMPLE_MS;</a>
<a name="ln180">                err_code |= rt_adc_vdd_sample();</a>
<a name="ln181">                RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln182">            }</a>
<a name="ln183">        }</a>
<a name="ln184">    }</a>
<a name="ln185">}</a>
<a name="ln186"> </a>
<a name="ln187">#ifndef CEEDLING</a>
<a name="ln188">static</a>
<a name="ln189">#endif</a>
<a name="ln190">void</a>
<a name="ln191">on_accelerometer_isr (const ri_gpio_evt_t event)</a>
<a name="ln192">{</a>
<a name="ln193">    if (RI_GPIO_SLOPE_LOTOHI == event.slope)</a>
<a name="ln194">    {</a>
<a name="ln195">        LOG (&quot;Movement \r\n&quot;);</a>
<a name="ln196">        app_sensor_event_increment();</a>
<a name="ln197">    }</a>
<a name="ln198">}</a>
<a name="ln199"> </a>
<a name="ln200">static ri_i2c_frequency_t rb_to_ri_i2c_freq (unsigned int rb_freq)</a>
<a name="ln201">{</a>
<a name="ln202">    ri_i2c_frequency_t freq = RI_I2C_FREQUENCY_100k;</a>
<a name="ln203"> </a>
<a name="ln204">    switch (rb_freq)</a>
<a name="ln205">    {</a>
<a name="ln206">        case RB_I2C_FREQUENCY_400k:</a>
<a name="ln207">            freq = RI_I2C_FREQUENCY_400k;</a>
<a name="ln208">            break;</a>
<a name="ln209"> </a>
<a name="ln210">        case RB_I2C_FREQUENCY_250k:</a>
<a name="ln211">            freq = RI_I2C_FREQUENCY_250k;</a>
<a name="ln212">            break;</a>
<a name="ln213"> </a>
<a name="ln214">        case RB_I2C_FREQUENCY_100k:</a>
<a name="ln215"> </a>
<a name="ln216">        // Intentional fall-through.</a>
<a name="ln217">        default:</a>
<a name="ln218">            freq = RI_I2C_FREQUENCY_100k;</a>
<a name="ln219">            break;</a>
<a name="ln220">    }</a>
<a name="ln221"> </a>
<a name="ln222">    return freq;</a>
<a name="ln223">}</a>
<a name="ln224"> </a>
<a name="ln225">static ri_spi_frequency_t rb_to_ri_spi_freq (unsigned int rb_freq)</a>
<a name="ln226">{</a>
<a name="ln227">    ri_spi_frequency_t freq = RI_SPI_FREQUENCY_1M;</a>
<a name="ln228"> </a>
<a name="ln229">    switch (rb_freq)</a>
<a name="ln230">    {</a>
<a name="ln231">        case RB_SPI_FREQUENCY_8M:</a>
<a name="ln232">            freq = RI_SPI_FREQUENCY_8M;</a>
<a name="ln233">            break;</a>
<a name="ln234"> </a>
<a name="ln235">        case RB_SPI_FREQUENCY_4M:</a>
<a name="ln236">            freq = RI_SPI_FREQUENCY_4M;</a>
<a name="ln237">            break;</a>
<a name="ln238"> </a>
<a name="ln239">        case RB_SPI_FREQUENCY_2M:</a>
<a name="ln240">            freq = RI_SPI_FREQUENCY_2M;</a>
<a name="ln241">            break;</a>
<a name="ln242"> </a>
<a name="ln243">        case RB_SPI_FREQUENCY_1M:</a>
<a name="ln244"> </a>
<a name="ln245">        // Intentional fall-through.</a>
<a name="ln246">        default:</a>
<a name="ln247">            freq = RI_SPI_FREQUENCY_1M;</a>
<a name="ln248">            break;</a>
<a name="ln249">    }</a>
<a name="ln250"> </a>
<a name="ln251">    return freq;</a>
<a name="ln252">}</a>
<a name="ln253"> </a>
<a name="ln254">static rd_status_t app_sensor_buses_init (void)</a>
<a name="ln255">{</a>
<a name="ln256">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln257">    ri_gpio_id_t ss_pins[RB_SPI_SS_NUMBER] = RB_SPI_SS_LIST;</a>
<a name="ln258">    ri_spi_init_config_t spi_config =</a>
<a name="ln259">    {</a>
<a name="ln260">        .mosi = RB_SPI_MOSI_PIN,</a>
<a name="ln261">        .miso = RB_SPI_MISO_PIN,</a>
<a name="ln262">        .sclk = RB_SPI_SCLK_PIN,</a>
<a name="ln263">        .ss_pins = ss_pins,</a>
<a name="ln264">        .ss_pins_number = sizeof (ss_pins) / sizeof (ri_gpio_id_t),</a>
<a name="ln265">        // Assume mode 0 always.</a>
<a name="ln266">        .mode = RI_SPI_MODE_0,</a>
<a name="ln267">        .frequency = rb_to_ri_spi_freq (RB_SPI_FREQ)</a>
<a name="ln268">    };</a>
<a name="ln269">    ri_i2c_init_config_t i2c_config =</a>
<a name="ln270">    {</a>
<a name="ln271">        .sda = RB_I2C_SDA_PIN,</a>
<a name="ln272">        .scl = RB_I2C_SCL_PIN,</a>
<a name="ln273">        .bus_pwr = RB_I2C_BUS_POWER_PIN,</a>
<a name="ln274">        .frequency = rb_to_ri_i2c_freq (RB_I2C_FREQ)</a>
<a name="ln275">    };</a>
<a name="ln276"> </a>
<a name="ln277">    if ( (!ri_gpio_is_init()) || (!ri_gpio_interrupt_is_init()))</a>
<a name="ln278">    {</a>
<a name="ln279">        err_code |= RD_ERROR_INVALID_STATE;</a>
<a name="ln280">    }</a>
<a name="ln281">    else</a>
<a name="ln282">    {</a>
<a name="ln283">        err_code |= ri_spi_init (&amp;spi_config);</a>
<a name="ln284">        err_code |= ri_i2c_init (&amp;i2c_config);</a>
<a name="ln285">    }</a>
<a name="ln286"> </a>
<a name="ln287">    return err_code;</a>
<a name="ln288">}</a>
<a name="ln289"> </a>
<a name="ln290">static rd_status_t app_sensor_buses_uninit (void)</a>
<a name="ln291">{</a>
<a name="ln292">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln293">    err_code |= ri_spi_uninit();</a>
<a name="ln294">    err_code |= ri_i2c_uninit();</a>
<a name="ln295">    return err_code;</a>
<a name="ln296">}</a>
<a name="ln297"> </a>
<a name="ln298">static void app_sensor_rtc_init (void)</a>
<a name="ln299">{</a>
<a name="ln300">    // Returns invalid state if already init, not a problem here.</a>
<a name="ln301">    (void) ri_rtc_init();</a>
<a name="ln302">    rd_sensor_timestamp_function_set (&amp;ri_rtc_millis);</a>
<a name="ln303">}</a>
<a name="ln304"> </a>
<a name="ln305">static void app_sensor_rtc_uninit (void)</a>
<a name="ln306">{</a>
<a name="ln307">    rd_sensor_timestamp_function_set (NULL);</a>
<a name="ln308">    (void) ri_rtc_uninit();</a>
<a name="ln309">}</a>
<a name="ln310"> </a>
<a name="ln311">rd_status_t app_sensor_init (void)</a>
<a name="ln312">{</a>
<a name="ln313">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln314">    m_sensors_init();</a>
<a name="ln315">    err_code |= app_sensor_buses_init();</a>
<a name="ln316"> </a>
<a name="ln317">    if (RD_SUCCESS == err_code)</a>
<a name="ln318">    {</a>
<a name="ln319">        app_sensor_rtc_init();</a>
<a name="ln320"> </a>
<a name="ln321">        for (size_t ii = 0; ii &lt; SENSOR_COUNT; ii++)</a>
<a name="ln322">        {</a>
<a name="ln323">            rd_status_t init_code = RD_SUCCESS;</a>
<a name="ln324">            size_t retries = 0;</a>
<a name="ln325"> </a>
<a name="ln326">            // Enable power to sensor</a>
<a name="ln327">            if (m_sensors[ii]-&gt;pwr_pin != RI_GPIO_ID_UNUSED)</a>
<a name="ln328">            {</a>
<a name="ln329">                (void) ri_gpio_configure (m_sensors[ii]-&gt;pwr_pin,</a>
<a name="ln330">                                          RI_GPIO_MODE_OUTPUT_HIGHDRIVE);</a>
<a name="ln331">                (void) ri_gpio_write (m_sensors[ii]-&gt;pwr_pin, m_sensors[ii]-&gt;pwr_on);</a>
<a name="ln332">            }</a>
<a name="ln333"> </a>
<a name="ln334">            // Some sensors, such as accelerometer may fail on user moving the board. Retry.</a>
<a name="ln335">            do</a>
<a name="ln336">            {</a>
<a name="ln337">                init_code = rt_sensor_initialize (m_sensors[ii]);</a>
<a name="ln338">            } while ( (APP_SENSOR_SELFTEST_RETRIES &gt; retries++)</a>
<a name="ln339"> </a>
<a name="ln340">                      &amp;&amp; (RD_ERROR_SELFTEST == init_code));</a>
<a name="ln341"> </a>
<a name="ln342">            if (RD_SUCCESS == init_code)</a>
<a name="ln343">            {</a>
<a name="ln344">                // Check for a configuration in flash.</a>
<a name="ln345">                init_code = rt_sensor_load (m_sensors[ii]);</a>
<a name="ln346"> </a>
<a name="ln347">                // Configuration found, use it.</a>
<a name="ln348">                if (RD_SUCCESS == init_code)</a>
<a name="ln349">                {</a>
<a name="ln350">                    init_code = rt_sensor_configure (m_sensors[ii]);</a>
<a name="ln351">                }</a>
<a name="ln352">                // Configuration not found, use defaults, store to flash.</a>
<a name="ln353">                else</a>
<a name="ln354">                {</a>
<a name="ln355">                    init_code = rt_sensor_configure (m_sensors[ii]);</a>
<a name="ln356">                    rt_sensor_store (m_sensors[ii]);</a>
<a name="ln357">                }</a>
<a name="ln358">            }</a>
<a name="ln359">            else if (RD_ERROR_SELFTEST == init_code)</a>
<a name="ln360">            {</a>
<a name="ln361">                err_code |= RD_ERROR_SELFTEST;</a>
<a name="ln362">            }</a>
<a name="ln363">            // Mark unavailable sensor handles as unused.</a>
<a name="ln364">            else</a>
<a name="ln365">            {</a>
<a name="ln366">                m_sensors[ii]-&gt;handle = APP_SENSOR_HANDLE_UNUSED;</a>
<a name="ln367">            }</a>
<a name="ln368">        }</a>
<a name="ln369">    }</a>
<a name="ln370"> </a>
<a name="ln371">    return err_code;</a>
<a name="ln372">}</a>
<a name="ln373"> </a>
<a name="ln374">rd_status_t app_sensor_uninit (void)</a>
<a name="ln375">{</a>
<a name="ln376">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln377"> </a>
<a name="ln378">    for (size_t ii = 0; ii &lt; SENSOR_COUNT; ii++)</a>
<a name="ln379">    {</a>
<a name="ln380">        if ( (NULL != m_sensors[ii]) &amp;&amp; rd_sensor_is_init (&amp; (m_sensors[ii]-&gt;sensor)))</a>
<a name="ln381">        {</a>
<a name="ln382">            m_sensors[ii]-&gt;sensor.uninit (&amp;m_sensors[ii]-&gt;sensor, m_sensors[ii]-&gt;bus,</a>
<a name="ln383">                                          m_sensors[ii]-&gt;handle);</a>
<a name="ln384"> </a>
<a name="ln385">            // Disable power to sensor</a>
<a name="ln386">            if (m_sensors[ii]-&gt;pwr_pin != RI_GPIO_ID_UNUSED)</a>
<a name="ln387">            {</a>
<a name="ln388">                (void) ri_gpio_write (m_sensors[ii]-&gt;pwr_pin, !m_sensors[ii]-&gt;pwr_on);</a>
<a name="ln389">                (void) ri_gpio_configure (m_sensors[ii]-&gt;pwr_pin, RI_GPIO_MODE_HIGH_Z);</a>
<a name="ln390">            }</a>
<a name="ln391">        }</a>
<a name="ln392">    }</a>
<a name="ln393"> </a>
<a name="ln394">    err_code |= app_sensor_buses_uninit();</a>
<a name="ln395">    app_sensor_rtc_uninit();</a>
<a name="ln396">    ri_radio_activity_callback_set (NULL);</a>
<a name="ln397">    return err_code;</a>
<a name="ln398">}</a>
<a name="ln399"> </a>
<a name="ln400">rd_sensor_data_fields_t app_sensor_available_data (void)</a>
<a name="ln401">{</a>
<a name="ln402">    rd_sensor_data_fields_t available = {0};</a>
<a name="ln403"> </a>
<a name="ln404">    for (size_t ii = 0; ii &lt; SENSOR_COUNT; ii++)</a>
<a name="ln405">    {</a>
<a name="ln406">        if ( (NULL != m_sensors[ii]) &amp;&amp; rd_sensor_is_init (&amp; (m_sensors[ii]-&gt;sensor)))</a>
<a name="ln407">        {</a>
<a name="ln408">            available.bitfield |= m_sensors[ii]-&gt;sensor.provides.bitfield;</a>
<a name="ln409">        }</a>
<a name="ln410">    }</a>
<a name="ln411"> </a>
<a name="ln412">    return available;</a>
<a name="ln413">}</a>
<a name="ln414"> </a>
<a name="ln415">rd_status_t app_sensor_get (rd_sensor_data_t * const data)</a>
<a name="ln416">{</a>
<a name="ln417">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln418"> </a>
<a name="ln419">    for (size_t ii = 0; ii &lt; SENSOR_COUNT; ii++)</a>
<a name="ln420">    {</a>
<a name="ln421">        if ( (NULL != m_sensors[ii]) &amp;&amp; rd_sensor_is_init (&amp; (m_sensors[ii]-&gt;sensor)))</a>
<a name="ln422">        {</a>
<a name="ln423">            err_code |= m_sensors[ii]-&gt;sensor.data_get (data);</a>
<a name="ln424">        }</a>
<a name="ln425">    }</a>
<a name="ln426"> </a>
<a name="ln427">    return err_code;</a>
<a name="ln428">}</a>
<a name="ln429"> </a>
<a name="ln430">rd_sensor_t * app_sensor_find_provider (const rd_sensor_data_fields_t data)</a>
<a name="ln431">{</a>
<a name="ln432">    rd_sensor_t * provider = NULL;</a>
<a name="ln433"> </a>
<a name="ln434">    for (size_t ii = 0; (ii &lt; SENSOR_COUNT) &amp;&amp; (NULL == provider); ii++)</a>
<a name="ln435">    {</a>
<a name="ln436">        if ( (NULL != m_sensors[ii]) &amp;&amp; rd_sensor_is_init (&amp; (m_sensors[ii]-&gt;sensor))</a>
<a name="ln437">                &amp;&amp; (! (~ (m_sensors[ii]-&gt;sensor.provides.bitfield) &amp; data.bitfield)))</a>
<a name="ln438">        {</a>
<a name="ln439">            provider = &amp; (m_sensors[ii]-&gt;sensor);</a>
<a name="ln440">        }</a>
<a name="ln441">    }</a>
<a name="ln442"> </a>
<a name="ln443">    return provider;</a>
<a name="ln444">}</a>
<a name="ln445"> </a>
<a name="ln446">void app_sensor_event_increment (void)</a>
<a name="ln447">{</a>
<a name="ln448">    m_event_counter++;</a>
<a name="ln449">}</a>
<a name="ln450"> </a>
<a name="ln451">uint32_t app_sensor_event_count_get (void)</a>
<a name="ln452">{</a>
<a name="ln453">    return m_event_counter;</a>
<a name="ln454">}</a>
<a name="ln455"> </a>
<a name="ln456">rd_status_t app_sensor_acc_thr_set (float * const threshold_g)</a>
<a name="ln457">{</a>
<a name="ln458">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln459">    const rd_sensor_data_fields_t acceleration =</a>
<a name="ln460">    {</a>
<a name="ln461">        .datas.acceleration_x_g = 1,</a>
<a name="ln462">        .datas.acceleration_y_g = 1,</a>
<a name="ln463">        .datas.acceleration_z_g = 1</a>
<a name="ln464">    };</a>
<a name="ln465">    const rd_sensor_t * const provider = app_sensor_find_provider (acceleration);</a>
<a name="ln466"> </a>
<a name="ln467">    if (RI_GPIO_ID_UNUSED == RB_INT_LEVEL_PIN)</a>
<a name="ln468">    {</a>
<a name="ln469">        err_code |= RD_ERROR_NOT_SUPPORTED;</a>
<a name="ln470">    }</a>
<a name="ln471">    else if ( (NULL == provider) || (NULL == provider-&gt;level_interrupt_set))</a>
<a name="ln472">    {</a>
<a name="ln473">        err_code |= RD_ERROR_NOT_SUPPORTED;</a>
<a name="ln474">    }</a>
<a name="ln475">    else if (NULL == threshold_g)</a>
<a name="ln476">    {</a>
<a name="ln477">        ri_gpio_interrupt_disable (RB_INT_LEVEL_PIN);</a>
<a name="ln478">        err_code |= provider-&gt;level_interrupt_set (false, threshold_g);</a>
<a name="ln479">    }</a>
<a name="ln480">    else if (0 &gt; *threshold_g)</a>
<a name="ln481">    {</a>
<a name="ln482">        err_code |= RD_ERROR_NOT_IMPLEMENTED;</a>
<a name="ln483">    }</a>
<a name="ln484">    else</a>
<a name="ln485">    {</a>
<a name="ln486">        err_code |= ri_gpio_interrupt_enable (RB_INT_LEVEL_PIN,</a>
<a name="ln487">                                              RI_GPIO_SLOPE_TOGGLE,</a>
<a name="ln488">                                              RI_GPIO_MODE_INPUT_NOPULL,</a>
<a name="ln489">                                              &amp;on_accelerometer_isr);</a>
<a name="ln490">        err_code |= provider-&gt;level_interrupt_set (true, threshold_g);</a>
<a name="ln491">    }</a>
<a name="ln492"> </a>
<a name="ln493">    return err_code;</a>
<a name="ln494">}</a>
<a name="ln495"> </a>
<a name="ln496">/**</a>
<a name="ln497"> * @brief Determine which fields are affected by given endpoint.</a>
<a name="ln498"> *</a>
<a name="ln499"> * @param[in] type Ruuvi Endpoint type.</a>
<a name="ln500"> * @return Ruuvi Driver fields corresponding to endpoint.</a>
<a name="ln501"> */</a>
<a name="ln502">static rd_sensor_data_fields_t re2rd_fields (const re_type_t type)</a>
<a name="ln503">{</a>
<a name="ln504">    rd_sensor_data_fields_t fields = {0};</a>
<a name="ln505"> </a>
<a name="ln506">    switch (type)</a>
<a name="ln507">    {</a>
<a name="ln508">        case RE_ACC_XYZ:</a>
<a name="ln509">            fields.datas.acceleration_x_g = 1;</a>
<a name="ln510">            fields.datas.acceleration_y_g = 1;</a>
<a name="ln511">            fields.datas.acceleration_z_g = 1;</a>
<a name="ln512">            break;</a>
<a name="ln513"> </a>
<a name="ln514">        case RE_ACC_X:</a>
<a name="ln515">            fields.datas.acceleration_x_g = 1;</a>
<a name="ln516">            break;</a>
<a name="ln517"> </a>
<a name="ln518">        case RE_ACC_Y:</a>
<a name="ln519">            fields.datas.acceleration_y_g = 1;</a>
<a name="ln520">            break;</a>
<a name="ln521"> </a>
<a name="ln522">        case RE_ACC_Z:</a>
<a name="ln523">            fields.datas.acceleration_z_g = 1;</a>
<a name="ln524">            break;</a>
<a name="ln525"> </a>
<a name="ln526">        case RE_GYR_XYZ:</a>
<a name="ln527">            fields.datas.gyro_x_dps = 1;</a>
<a name="ln528">            fields.datas.gyro_y_dps = 1;</a>
<a name="ln529">            fields.datas.gyro_z_dps = 1;</a>
<a name="ln530">            break;</a>
<a name="ln531"> </a>
<a name="ln532">        case RE_GYR_X:</a>
<a name="ln533">            fields.datas.gyro_x_dps = 1;</a>
<a name="ln534">            break;</a>
<a name="ln535"> </a>
<a name="ln536">        case RE_GYR_Y:</a>
<a name="ln537">            fields.datas.gyro_y_dps = 1;</a>
<a name="ln538">            break;</a>
<a name="ln539"> </a>
<a name="ln540">        case RE_GYR_Z:</a>
<a name="ln541">            fields.datas.gyro_z_dps = 1;</a>
<a name="ln542">            break;</a>
<a name="ln543"> </a>
<a name="ln544">        case RE_ENV_ALL:</a>
<a name="ln545">            fields.datas.humidity_rh = 1;</a>
<a name="ln546">            fields.datas.pressure_pa = 1;</a>
<a name="ln547">            fields.datas.temperature_c = 1;</a>
<a name="ln548">            break;</a>
<a name="ln549"> </a>
<a name="ln550">        case RE_ENV_HUMI:</a>
<a name="ln551">            fields.datas.humidity_rh = 1;</a>
<a name="ln552">            break;</a>
<a name="ln553"> </a>
<a name="ln554">        case RE_ENV_PRES:</a>
<a name="ln555">            fields.datas.pressure_pa = 1;</a>
<a name="ln556">            break;</a>
<a name="ln557"> </a>
<a name="ln558">        case RE_ENV_TEMP:</a>
<a name="ln559">            fields.datas.temperature_c = 1;</a>
<a name="ln560">            break;</a>
<a name="ln561"> </a>
<a name="ln562">        default:</a>
<a name="ln563">            RD_ERROR_CHECK (RD_ERROR_NOT_IMPLEMENTED, ~RD_ERROR_FATAL);</a>
<a name="ln564">            break;</a>
<a name="ln565">    }</a>
<a name="ln566"> </a>
<a name="ln567">    return fields;</a>
<a name="ln568">}</a>
<a name="ln569"> </a>
<a name="ln570">/**</a>
<a name="ln571"> * @brief Convert Ruuvi Driver data type to Ruuvi endpoint header.</a>
<a name="ln572"> *</a>
<a name="ln573"> * @param[in] field Data field to convert, exactly one must be set.</a>
<a name="ln574"> * @return Ruuvi Endpoint constant corresponding to field. 0 if field is invalid.</a>
<a name="ln575"> */</a>
<a name="ln576">static uint8_t rd2re_fields (const rd_sensor_data_bitfield_t fields)</a>
<a name="ln577">{</a>
<a name="ln578">    // Implementing field-&gt;header assigments as a look-up table would</a>
<a name="ln579">    // rely on specific representation of bitfield at compile time.</a>
<a name="ln580">    // Little-endian, big-endian, BE-8, BE-32 etc. Using if-else</a>
<a name="ln581">    // here for robustness.</a>
<a name="ln582">    uint8_t header_value = 0;</a>
<a name="ln583"> </a>
<a name="ln584">    if (fields.acceleration_x_g)</a>
<a name="ln585">    {</a>
<a name="ln586">        header_value = RE_ACC_X;</a>
<a name="ln587">    }</a>
<a name="ln588">    else if (fields.acceleration_y_g)</a>
<a name="ln589">    {</a>
<a name="ln590">        header_value = RE_ACC_Y;</a>
<a name="ln591">    }</a>
<a name="ln592">    else if (fields.acceleration_z_g)</a>
<a name="ln593">    {</a>
<a name="ln594">        header_value = RE_ACC_Z;</a>
<a name="ln595">    }</a>
<a name="ln596">    else if (fields.gyro_x_dps)</a>
<a name="ln597">    {</a>
<a name="ln598">        header_value = RE_GYR_X;</a>
<a name="ln599">    }</a>
<a name="ln600">    else if (fields.gyro_y_dps)</a>
<a name="ln601">    {</a>
<a name="ln602">        header_value = RE_GYR_Y;</a>
<a name="ln603">    }</a>
<a name="ln604">    else if (fields.gyro_z_dps)</a>
<a name="ln605">    {</a>
<a name="ln606">        header_value = RE_GYR_Z;</a>
<a name="ln607">    }</a>
<a name="ln608">    else if (fields.humidity_rh)</a>
<a name="ln609">    {</a>
<a name="ln610">        header_value = RE_ENV_HUMI;</a>
<a name="ln611">    }</a>
<a name="ln612">    else if (fields.pressure_pa)</a>
<a name="ln613">    {</a>
<a name="ln614">        header_value = RE_ENV_PRES;</a>
<a name="ln615">    }</a>
<a name="ln616">    else if (fields.temperature_c)</a>
<a name="ln617">    {</a>
<a name="ln618">        header_value = RE_ENV_TEMP;</a>
<a name="ln619">    }</a>
<a name="ln620">    else</a>
<a name="ln621">    {</a>
<a name="ln622">        // No action needed</a>
<a name="ln623">    }</a>
<a name="ln624"> </a>
<a name="ln625">    return header_value;</a>
<a name="ln626">}</a>
<a name="ln627"> </a>
<a name="ln628">/**</a>
<a name="ln629"> * @brief encode log element into given buffer.</a>
<a name="ln630"> *</a>
<a name="ln631"> * @param[in] buffer Buffer to encode data into.</a>
<a name="ln632"> * @param[in] timestamp_ms Float value to encode.</a>
<a name="ln633"> * @param[in] data Float value to encode.</a>
<a name="ln634"> * @param[in] type Type of data to encode. Only one type/message is implemented.</a>
<a name="ln635"> *</a>
<a name="ln636"> * @note This function will not set the destination endpoint in buffer.</a>
<a name="ln637"> * @retval RD_SUCCESS Data was encoded successfully.</a>
<a name="ln638"> * @retval RD_ERROR_NULL Buffer or data was NULL.</a>
<a name="ln639"> * @retval RD_ERROR_INVALID_PARAM Type had no field set.</a>
<a name="ln640"> * @retval RD_ERROR_NOT_IMPLEMENTED Type had &gt; 1 field set or encoding type is not implemented.</a>
<a name="ln641"> */</a>
<a name="ln642">static rd_status_t app_sensor_encode_log (uint8_t * const buffer,</a>
<a name="ln643">        const uint64_t timestamp_ms,</a>
<a name="ln644">        const float data,</a>
<a name="ln645">        const rd_sensor_data_bitfield_t type)</a>
<a name="ln646">{</a>
<a name="ln647">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln648">    const uint8_t source = rd2re_fields (type);</a>
<a name="ln649"> </a>
<a name="ln650">    if (0 != source)</a>
<a name="ln651">    {</a>
<a name="ln652">        re_log_write_header (buffer, source);</a>
<a name="ln653">        re_log_write_timestamp (buffer, timestamp_ms);</a>
<a name="ln654">        re_log_write_data (buffer, data, source);</a>
<a name="ln655">    }</a>
<a name="ln656">    else</a>
<a name="ln657">    {</a>
<a name="ln658">        err_code |= RD_ERROR_INVALID_PARAM;</a>
<a name="ln659">    }</a>
<a name="ln660"> </a>
<a name="ln661">    return err_code;</a>
<a name="ln662">}</a>
<a name="ln663"> </a>
<a name="ln664">/**</a>
<a name="ln665"> * if valid data in sample</a>
<a name="ln666"> * parse data type</a>
<a name="ln667"> * parse data value</a>
<a name="ln668"> * format msg</a>
<a name="ln669"> * send msg</a>
<a name="ln670"> */</a>
<a name="ln671">static rd_status_t send_field (const ri_comm_xfer_fp_t reply_fp,</a>
<a name="ln672">                               const uint8_t * const raw_message,</a>
<a name="ln673">                               const rd_sensor_data_bitfield_t type,</a>
<a name="ln674">                               const float value,</a>
<a name="ln675">                               const int64_t real_time_ms)</a>
<a name="ln676">{</a>
<a name="ln677">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln678">    ri_comm_message_t msg = {0};</a>
<a name="ln679">    err_code |= app_sensor_encode_log (msg.data, real_time_ms, value,</a>
<a name="ln680">                                       type);</a>
<a name="ln681"> </a>
<a name="ln682">    if (RD_SUCCESS == err_code)</a>
<a name="ln683">    {</a>
<a name="ln684">        msg.repeat_count = 1;</a>
<a name="ln685">        msg.data_length = RE_STANDARD_MESSAGE_LENGTH;</a>
<a name="ln686">        msg.data[RE_STANDARD_DESTINATION_INDEX] = raw_message[RE_STANDARD_SOURCE_INDEX];</a>
<a name="ln687">        err_code |= app_comms_blocking_send (reply_fp, &amp;msg);</a>
<a name="ln688">    }</a>
<a name="ln689"> </a>
<a name="ln690">    return err_code;</a>
<a name="ln691">}</a>
<a name="ln692"> </a>
<a name="ln693">/**</a>
<a name="ln694"> * @brief Send data element.</a>
<a name="ln695"> *</a>
<a name="ln696"> * This function sends given data element to given reply function pointer.</a>
<a name="ln697"> *</a>
<a name="ln698"> * @param[in] reply_fp Function pointer to reply to.</a>
<a name="ln699"> * @param[in] raw_message original query from remote.</a>
<a name="ln700"> * @param[in] sample Data sample to send.</a>
<a name="ln701"> * @param[in] time_offset_ms Offset between tag time and real time.</a>
<a name="ln702"> * @retval RD_SUCCESS reply was sent successfully.</a>
<a name="ln703"> * @retval error code from reply_fp in case of error.</a>
<a name="ln704"> *</a>
<a name="ln705"> * @note This function blocks until reply_fp returns something else than</a>
<a name="ln706"> *       RD_ERROR_NO_MEM.</a>
<a name="ln707"> */</a>
<a name="ln708">static rd_status_t app_sensor_send_data (const ri_comm_xfer_fp_t reply_fp,</a>
<a name="ln709">        const uint8_t * const raw_message,</a>
<a name="ln710">        const rd_sensor_data_t * const sample,</a>
<a name="ln711">        const int64_t time_offset_ms)</a>
<a name="ln712">{</a>
<a name="ln713">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln714">    const uint8_t fieldcount = rd_sensor_data_fieldcount (sample);</a>
<a name="ln715">    int64_t real_time_ms = 0;</a>
<a name="ln716"> </a>
<a name="ln717">    if ( (0 - time_offset_ms) &lt; (int64_t) sample-&gt;timestamp_ms)</a>
<a name="ln718">    {</a>
<a name="ln719">        real_time_ms = sample-&gt;timestamp_ms + time_offset_ms;</a>
<a name="ln720">    }</a>
<a name="ln721"> </a>
<a name="ln722">    for (uint8_t ii = 0; ii &lt; fieldcount; ii++)</a>
<a name="ln723">    {</a>
<a name="ln724">        if (rd_sensor_has_valid_data (sample, ii))</a>
<a name="ln725">        {</a>
<a name="ln726">            rd_sensor_data_bitfield_t type = rd_sensor_field_type (sample, ii);</a>
<a name="ln727">            err_code |= send_field (reply_fp, raw_message,</a>
<a name="ln728">                                    type, sample-&gt;data[ii], real_time_ms);</a>
<a name="ln729">        }</a>
<a name="ln730">    }</a>
<a name="ln731"> </a>
<a name="ln732">    return err_code;</a>
<a name="ln733">}</a>
<a name="ln734"> </a>
<a name="ln735">/**</a>
<a name="ln736"> * @brief Send no more sensor log data message.</a>
<a name="ln737"> * TODO -refactor encoding to endpoints.</a>
<a name="ln738"> * TODO -refactor into comms</a>
<a name="ln739"> */</a>
<a name="ln740">static rd_status_t app_sensor_send_eof (const ri_comm_xfer_fp_t reply_fp,</a>
<a name="ln741">                                        const uint8_t * const raw_message)</a>
<a name="ln742">{</a>
<a name="ln743">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln744">    ri_comm_message_t msg = {0};</a>
<a name="ln745">    msg.data_length = RE_STANDARD_MESSAGE_LENGTH;</a>
<a name="ln746">    msg.data[RE_STANDARD_DESTINATION_INDEX] = raw_message[RE_STANDARD_SOURCE_INDEX];</a>
<a name="ln747">    msg.data[RE_STANDARD_SOURCE_INDEX] = raw_message[RE_STANDARD_DESTINATION_INDEX];</a>
<a name="ln748">    msg.data[RE_STANDARD_OPERATION_INDEX] = RE_STANDARD_LOG_VALUE_WRITE;</a>
<a name="ln749">    memset (&amp;msg.data[RE_STANDARD_HEADER_LENGTH], 0xFF, RE_STANDARD_PAYLOAD_LENGTH);</a>
<a name="ln750">    app_comms_blocking_send (reply_fp, &amp;msg);</a>
<a name="ln751">    return err_code;</a>
<a name="ln752">}</a>
<a name="ln753"> </a>
<a name="ln754">/**</a>
<a name="ln755"> * @brief Send heartbeat overdue data message.</a>
<a name="ln756"> * TODO -refactor encoding to endpoints.</a>
<a name="ln757"> * TODO -refactor into comms</a>
<a name="ln758"> */</a>
<a name="ln759">static rd_status_t app_sensor_send_timeout (const ri_comm_xfer_fp_t reply_fp,</a>
<a name="ln760">        const uint8_t * const raw_message)</a>
<a name="ln761">{</a>
<a name="ln762">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln763">    ri_comm_message_t msg = {0};</a>
<a name="ln764">    msg.data_length = RE_STANDARD_MESSAGE_LENGTH;</a>
<a name="ln765">    msg.data[RE_STANDARD_DESTINATION_INDEX] = raw_message[RE_STANDARD_SOURCE_INDEX];</a>
<a name="ln766">    msg.data[RE_STANDARD_SOURCE_INDEX] = raw_message[RE_STANDARD_DESTINATION_INDEX];</a>
<a name="ln767">    msg.data[RE_STANDARD_OPERATION_INDEX] = RE_STANDARD_OP_TIMEOUT;</a>
<a name="ln768">    memset (&amp;msg.data[RE_STANDARD_HEADER_LENGTH], 0xFF, RE_STANDARD_PAYLOAD_LENGTH);</a>
<a name="ln769">    app_comms_blocking_send (reply_fp, &amp;msg);</a>
<a name="ln770">    return err_code;</a>
<a name="ln771">}</a>
<a name="ln772"> </a>
<a name="ln773">/**</a>
<a name="ln774"> * @brief Log read sensor op.</a>
<a name="ln775"> *</a>
<a name="ln776"> * @ref sensor_op.</a>
<a name="ln777"> *</a>
<a name="ln778"> * @param[in] reply_fp Function pointer to which send logs.</a>
<a name="ln779"> * @param[fields] Fields to read.</a>
<a name="ln780"> * @param[raw_message] Original message from remote.</a>
<a name="ln781"> * @retval RD_SUCCESS on success.</a>
<a name="ln782"> * @retval RD_ERROR_INVALID_PARAM if start of logs is after current time.</a>
<a name="ln783"> * @retval error code from reply_fp if reply fails.</a>
<a name="ln784"> *</a>
<a name="ln785"> * @note This function blocks until all requested logs are sent and will therefore</a>
<a name="ln786"> *       block for a long time.</a>
<a name="ln787"> */</a>
<a name="ln788">static rd_status_t app_sensor_log_read (const ri_comm_xfer_fp_t reply_fp,</a>
<a name="ln789">                                        const rd_sensor_data_fields_t fields,</a>
<a name="ln790">                                        const uint8_t * const raw_message)</a>
<a name="ln791">{</a>
<a name="ln792">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln793">    rd_sensor_data_t sample = {0};</a>
<a name="ln794">    sample.fields = fields;</a>
<a name="ln795">    float data[rd_sensor_data_fieldcount (&amp;sample)];</a>
<a name="ln796">    sample.data = data;</a>
<a name="ln797">    // Parse start, end times.</a>
<a name="ln798">    uint32_t current_time_s = re_std_log_current_time (raw_message);</a>
<a name="ln799">    uint32_t start_s = re_std_log_start_time (raw_message);</a>
<a name="ln800">    uint32_t sent_elements = 0;</a>
<a name="ln801">    const uint64_t system_time_ms = ri_rtc_millis();</a>
<a name="ln802"> </a>
<a name="ln803">    // Cannot have start_s &gt;= current_time_s</a>
<a name="ln804">    if (current_time_s &gt; start_s)</a>
<a name="ln805">    {</a>
<a name="ln806">        // Parse offset to system clock - flows over in 68 years.</a>
<a name="ln807">        LOG (&quot;Sending logged data\r\n&quot;);</a>
<a name="ln808">        int32_t system_time_s = (int32_t) (system_time_ms / 1000U);</a>
<a name="ln809">        int64_t offset_ms = ( (int64_t) current_time_s - (int64_t) system_time_s) *</a>
<a name="ln810">                            (int64_t) 1000;</a>
<a name="ln811">        int64_t time_diff_ms = (current_time_s - start_s) * 1000U;</a>
<a name="ln812">        // First sample to send in real time</a>
<a name="ln813">        sample.timestamp_ms = (start_s * 1000U);</a>
<a name="ln814"> </a>
<a name="ln815">        // Offset sample time to system clock.</a>
<a name="ln816">        if (time_diff_ms &gt; system_time_ms)</a>
<a name="ln817">        {</a>
<a name="ln818">            sample.timestamp_ms = 0;</a>
<a name="ln819">        }</a>
<a name="ln820">        else</a>
<a name="ln821">        {</a>
<a name="ln822">            sample.timestamp_ms = system_time_ms - time_diff_ms;</a>
<a name="ln823">        }</a>
<a name="ln824"> </a>
<a name="ln825">        app_log_read_state_t rs =</a>
<a name="ln826">        {</a>
<a name="ln827">            .oldest_element_ms = sample.timestamp_ms,</a>
<a name="ln828">            .element_idx = 0,</a>
<a name="ln829">            .page_idx = 0</a>
<a name="ln830">        };</a>
<a name="ln831"> </a>
<a name="ln832">        while (RD_SUCCESS == err_code)</a>
<a name="ln833">        {</a>
<a name="ln834">            // Reset data validity</a>
<a name="ln835">            sample.valid.bitfield = 0;</a>
<a name="ln836">            // Timestamp and fields are set in log read function.</a>
<a name="ln837">            err_code |= app_log_read (&amp;sample, &amp;rs);</a>
<a name="ln838"> </a>
<a name="ln839">            if (RD_ERROR_NOT_FOUND == err_code)</a>
<a name="ln840">            {</a>
<a name="ln841">                err_code |= app_sensor_send_eof (reply_fp, raw_message);</a>
<a name="ln842">                char msg[128];</a>
<a name="ln843">                snprintf (msg, sizeof (msg), &quot;Logged data sent: %lu elements\r\n&quot;, sent_elements); //-V576</a>
<a name="ln844">                LOG (msg);</a>
<a name="ln845">                sent_elements = 0;</a>
<a name="ln846">            }</a>
<a name="ln847">            else if (app_heartbeat_overdue())</a>
<a name="ln848">            {</a>
<a name="ln849">                err_code |= RD_ERROR_TIMEOUT;</a>
<a name="ln850">                err_code |= app_sensor_send_timeout (reply_fp, raw_message);</a>
<a name="ln851">            }</a>
<a name="ln852">            // If data element was found, send log element.</a>
<a name="ln853">            else if (RD_SUCCESS == err_code)</a>
<a name="ln854">            {</a>
<a name="ln855">                err_code |= app_sensor_send_data (reply_fp, raw_message,</a>
<a name="ln856">                                                  &amp;sample, offset_ms);</a>
<a name="ln857">                sent_elements++;</a>
<a name="ln858">                LOGD (&quot;S&quot;);</a>
<a name="ln859">            }</a>
<a name="ln860">            else</a>
<a name="ln861">            {</a>
<a name="ln862">                // No action needed, error code gets returned to caller.</a>
<a name="ln863">            }</a>
<a name="ln864">        }</a>
<a name="ln865">    }</a>
<a name="ln866">    // Start time &gt;= current time</a>
<a name="ln867">    else</a>
<a name="ln868">    {</a>
<a name="ln869">        err_code |= RD_ERROR_INVALID_PARAM;</a>
<a name="ln870">    }</a>
<a name="ln871"> </a>
<a name="ln872">    // Send op status, remove expected not found</a>
<a name="ln873">    err_code &amp;= ~RD_ERROR_NOT_FOUND;</a>
<a name="ln874">    return err_code;</a>
<a name="ln875">}</a>
<a name="ln876"> </a>
<a name="ln877">rd_status_t app_sensor_handle (const ri_comm_xfer_fp_t reply_fp,</a>
<a name="ln878">                               const uint8_t * const raw_message,</a>
<a name="ln879">                               const uint16_t data_len)</a>
<a name="ln880">{</a>
<a name="ln881">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln882"> </a>
<a name="ln883">    if (NULL == raw_message)</a>
<a name="ln884">    {</a>
<a name="ln885">        err_code |= RD_ERROR_NULL;</a>
<a name="ln886">    }</a>
<a name="ln887">    else if (data_len &lt; RE_STANDARD_MESSAGE_LENGTH)</a>
<a name="ln888">    {</a>
<a name="ln889">        err_code |= RD_ERROR_DATA_SIZE;</a>
<a name="ln890">    }</a>
<a name="ln891">    else</a>
<a name="ln892">    {</a>
<a name="ln893">        // Parse affected fields. It's ok to have unspecified value here,</a>
<a name="ln894">        // in that case fields end up being empty and error is reported via reply_fp.</a>
<a name="ln895">        re_type_t type = (re_type_t) raw_message[RE_STANDARD_DESTINATION_INDEX];</a>
<a name="ln896">        rd_sensor_data_fields_t target_fields = re2rd_fields (type);</a>
<a name="ln897">        // Parse desired operation.</a>
<a name="ln898">        re_op_t op = (re_op_t) raw_message[RE_STANDARD_OPERATION_INDEX];</a>
<a name="ln899"> </a>
<a name="ln900">        // If target and op are valid, execute.</a>
<a name="ln901">        switch (op)</a>
<a name="ln902">        {</a>
<a name="ln903">            case RE_STANDARD_LOG_VALUE_READ:</a>
<a name="ln904">                err_code |= app_sensor_log_read (reply_fp,</a>
<a name="ln905">                                                 target_fields, raw_message);</a>
<a name="ln906">                break;</a>
<a name="ln907"> </a>
<a name="ln908">            default:</a>
<a name="ln909">                // Reply with error on unknown op.</a>
<a name="ln910">                break;</a>
<a name="ln911">        }</a>
<a name="ln912">    }</a>
<a name="ln913"> </a>
<a name="ln914">    return err_code;</a>
<a name="ln915">}</a>
<a name="ln916"> </a>
<a name="ln917">rd_status_t app_sensor_vdd_sample (void)</a>
<a name="ln918">{</a>
<a name="ln919">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln920">    rd_sensor_configuration_t configuration =</a>
<a name="ln921">    {</a>
<a name="ln922">        .dsp_function = RD_SENSOR_CFG_DEFAULT,</a>
<a name="ln923">        .dsp_parameter = RD_SENSOR_CFG_DEFAULT,</a>
<a name="ln924">        .mode = RD_SENSOR_CFG_SINGLE,</a>
<a name="ln925">        .resolution = RD_SENSOR_CFG_DEFAULT,</a>
<a name="ln926">        .samplerate = RD_SENSOR_CFG_DEFAULT,</a>
<a name="ln927">        .scale = RD_SENSOR_CFG_DEFAULT</a>
<a name="ln928">    };</a>
<a name="ln929">    err_code |= rt_adc_vdd_prepare (&amp;configuration);</a>
<a name="ln930">    err_code |= rt_adc_vdd_sample();</a>
<a name="ln931">    return err_code;</a>
<a name="ln932">}</a>
<a name="ln933"> </a>
<a name="ln934">#ifdef RUUVI_RUN_TESTS</a>
<a name="ln935">void app_sensor_ctx_get (rt_sensor_ctx_t *** p_sensors, size_t * num_sensors)</a>
<a name="ln936">{</a>
<a name="ln937">    *p_sensors = m_sensors;</a>
<a name="ln938">    *num_sensors = SENSOR_COUNT;</a>
<a name="ln939">}</a>
<a name="ln940">#endif</a>
<a name="ln941"> </a>
<a name="ln942">/** @} */</a>

</code></pre>
<div class="balloon" rel="83"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="87"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="91"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="99"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="103"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="176"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '==' operator should have the same essential type. The current types are: 'signed' and 'Boolean'.</p></div>
<div class="balloon" rel="257"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="260"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="261"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="262"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="271"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="272"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="273"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="321"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '<' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="327"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '!=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="331"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the 'm_sensors[ii]->pwr_on' expression should not be converted from the essential 'ri_gpio_state_t' type to the essential 'unsigned' type.</p></div>
<div class="balloon" rel="366"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xFFU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="378"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '<' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="386"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '!=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="388"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The 'm_sensors[ii]->pwr_on' operand of the '!' operator should not have the essential 'ri_gpio_state_t' type.</p></div>
<div class="balloon" rel="388"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2570/" target="_blank">V2570</a> Operands of the '!' operator should have bool essential type.</p></div>
<div class="balloon" rel="388"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '!m_sensors[ii]->pwr_on' expression should not be converted from the essential 'Boolean' type to the essential 'unsigned' type.</p></div>
<div class="balloon" rel="404"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '<' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="419"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '<' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="434"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '<' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="437"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> Operand of the '!' operator should have an appropriate essential type.</p></div>
<div class="balloon" rel="437"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2570/" target="_blank">V2570</a> Operands of the '!' operator should have bool essential type.</p></div>
<div class="balloon" rel="467"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="477"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="480"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '>' operator should have the same essential type. The current types are: 'signed' and 'floating'.</p></div>
<div class="balloon" rel="486"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="509"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="510"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="511"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="515"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="519"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="523"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="527"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="528"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="529"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="533"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="537"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="541"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="545"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="546"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="547"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="551"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="555"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="559"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="586"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="590"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="594"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="598"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="602"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="606"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="610"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="614"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="618"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="650"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '!=' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="684"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="685"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '((3U) + (8U))' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="719"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '+' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="719"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the 'sample->timestamp_ms + time_offset_ms' expression should not be converted from the essential 'unsigned' type to the essential 'signed' type.</p></div>
<div class="balloon" rel="719"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="745"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '((3U) + (8U))' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="748"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0x10U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="764"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '((3U) + (8U))' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="767"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="811"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(current_time_s - start_s) * 1000U' expression should not be converted from the essential 'unsigned' type to the essential 'signed' type.</p></div>
<div class="balloon" rel="816"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '>' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="818"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="822"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '-' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="835"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="845"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="895"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2531/" target="_blank">V2531</a> The 'raw_message[(0U)]' expression of the essential 'unsigned' type should not be cast to the essential 're_type_t' type.</p></div>
<div class="balloon" rel="898"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2531/" target="_blank">V2531</a> The 'raw_message[(2U)]' expression of the essential 'unsigned' type should not be cast to the essential 're_op_t' type.</p></div>
<div class="balloon" rel="903"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> Constant expression of the case label of the essential 'unsigned' type should not be converted to the essential 're_op_t' type of the controlling expression.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
