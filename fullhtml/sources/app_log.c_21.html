
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>app_log.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;app_log.h&quot;</a>
<a name="ln2"> </a>
<a name="ln3">#include &quot;app_config.h&quot;</a>
<a name="ln4">#include &quot;ruuvi_driver_error.h&quot;</a>
<a name="ln5">#include &quot;ruuvi_driver_sensor.h&quot;</a>
<a name="ln6">#include &quot;ruuvi_library.h&quot;</a>
<a name="ln7">#include &quot;ruuvi_library_compress.h&quot;</a>
<a name="ln8">#include &quot;ruuvi_interface_log.h&quot;</a>
<a name="ln9">#include &quot;ruuvi_interface_yield.h&quot;</a>
<a name="ln10">#include &quot;ruuvi_task_flash.h&quot;</a>
<a name="ln11">#if RT_FLASH_ENABLED</a>
<a name="ln12"> </a>
<a name="ln13">static inline void LOG (const char * const msg)</a>
<a name="ln14">{</a>
<a name="ln15">    ri_log (RI_LOG_LEVEL_INFO, msg);</a>
<a name="ln16">}</a>
<a name="ln17"> </a>
<a name="ln18">static inline void LOGD (const char * const msg)</a>
<a name="ln19">{</a>
<a name="ln20">    ri_log (RI_LOG_LEVEL_DEBUG, msg);</a>
<a name="ln21">}</a>
<a name="ln22"> </a>
<a name="ln23"> </a>
<a name="ln24">/**</a>
<a name="ln25"> * @addtogroup app_log</a>
<a name="ln26"> */</a>
<a name="ln27">/** @{ */</a>
<a name="ln28">/**</a>
<a name="ln29"> * @file app_log.c</a>
<a name="ln30"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln31"> * @date 2020-07-17</a>
<a name="ln32"> * @copyright Ruuvi Innovations Ltd, license BSD-3-Clause.</a>
<a name="ln33"> */</a>
<a name="ln34"> </a>
<a name="ln35">#ifndef CEEDLING</a>
<a name="ln36">static</a>
<a name="ln37">#endif</a>
<a name="ln38">app_log_record_t m_log_input_block;   //!&lt; Block to be stored to flash.</a>
<a name="ln39"> </a>
<a name="ln40">#ifndef CEEDLING</a>
<a name="ln41">static</a>
<a name="ln42">#endif</a>
<a name="ln43">app_log_record_t m_log_output_block;   //!&lt; Block read from flash for examination.</a>
<a name="ln44"> </a>
<a name="ln45">#ifndef CEEDLING</a>
<a name="ln46">static</a>
<a name="ln47">#endif</a>
<a name="ln48">app_log_config_t m_log_config; //!&lt; Configuration for logging.</a>
<a name="ln49"> </a>
<a name="ln50">#ifndef CEEDLING</a>
<a name="ln51">static</a>
<a name="ln52">#endif</a>
<a name="ln53">uint64_t m_last_sample_ms; //!&lt; Timestamp of last processed sample.</a>
<a name="ln54"> </a>
<a name="ln55">#ifndef CEEDLING</a>
<a name="ln56">static</a>
<a name="ln57">#endif</a>
<a name="ln58">uint16_t m_boot_count = 0;</a>
<a name="ln59"> </a>
<a name="ln60">static rd_status_t store_block (const app_log_record_t * const p_record)</a>
<a name="ln61">{</a>
<a name="ln62">    static uint8_t record_idx = 0;</a>
<a name="ln63">    uint8_t num_tries = 0;</a>
<a name="ln64">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln65"> </a>
<a name="ln66">    do</a>
<a name="ln67">    {</a>
<a name="ln68">        uint8_t record_slot = (record_idx + num_tries) % APP_FLASH_LOG_DATA_RECORDS_NUM;</a>
<a name="ln69">        uint16_t target_record = (APP_FLASH_LOG_DATA_RECORD_PREFIX &lt;&lt; 8U) + record_slot;</a>
<a name="ln70">        err_code = rt_flash_free (APP_FLASH_LOG_FILE, target_record);</a>
<a name="ln71"> </a>
<a name="ln72">        // It's not a problem if there wasn't old block to erase.</a>
<a name="ln73">        if (RD_SUCCESS == err_code)</a>
<a name="ln74">        {</a>
<a name="ln75">            char msg[128];</a>
<a name="ln76">            snprintf (msg, sizeof (msg), &quot;store_block:freed old record #%d\r\n&quot;, target_record);</a>
<a name="ln77">            LOG (msg);</a>
<a name="ln78">        }</a>
<a name="ln79">        else</a>
<a name="ln80">        {</a>
<a name="ln81">            char msg[128];</a>
<a name="ln82">            snprintf (msg, sizeof (msg), &quot;store_block:creating new record #%d\r\n&quot;, target_record);</a>
<a name="ln83">            LOG (msg);</a>
<a name="ln84">        }</a>
<a name="ln85"> </a>
<a name="ln86">        err_code &amp;= ~RD_ERROR_NOT_FOUND;</a>
<a name="ln87"> </a>
<a name="ln88">        while (rt_flash_busy())</a>
<a name="ln89">        {</a>
<a name="ln90">            ri_yield();</a>
<a name="ln91">        }</a>
<a name="ln92"> </a>
<a name="ln93">        err_code |= rt_flash_gc_run ();</a>
<a name="ln94"> </a>
<a name="ln95">        while (rt_flash_busy())</a>
<a name="ln96">        {</a>
<a name="ln97">            ri_yield();</a>
<a name="ln98">        }</a>
<a name="ln99"> </a>
<a name="ln100">        err_code |= rt_flash_store (APP_FLASH_LOG_FILE,</a>
<a name="ln101">                                    target_record,</a>
<a name="ln102">                                    p_record, sizeof (app_log_record_t));</a>
<a name="ln103"> </a>
<a name="ln104">        while (rt_flash_busy())</a>
<a name="ln105">        {</a>
<a name="ln106">            ri_yield();</a>
<a name="ln107">        }</a>
<a name="ln108"> </a>
<a name="ln109">        RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln110">        // Erase another block and try again if there was error.</a>
<a name="ln111">        num_tries++;</a>
<a name="ln112">    } while ( (RD_SUCCESS != err_code) &amp;&amp; (num_tries &lt; APP_FLASH_LOG_DATA_RECORDS_NUM));</a>
<a name="ln113"> </a>
<a name="ln114">    if (RD_SUCCESS == err_code)</a>
<a name="ln115">    {</a>
<a name="ln116">        record_idx += num_tries;</a>
<a name="ln117">        record_idx = record_idx % APP_FLASH_LOG_DATA_RECORDS_NUM;</a>
<a name="ln118">    }</a>
<a name="ln119"> </a>
<a name="ln120">    return err_code;</a>
<a name="ln121">}</a>
<a name="ln122"> </a>
<a name="ln123"> </a>
<a name="ln124">static rd_status_t purge_logs (void)</a>
<a name="ln125">{</a>
<a name="ln126">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln127"> </a>
<a name="ln128">    for (uint8_t record_idx = 0; record_idx &lt; APP_FLASH_LOG_DATA_RECORDS_NUM; record_idx++)</a>
<a name="ln129">    {</a>
<a name="ln130">        err_code |= rt_flash_free (APP_FLASH_LOG_FILE,</a>
<a name="ln131">                                   (APP_FLASH_LOG_DATA_RECORD_PREFIX &lt;&lt; 8U) + record_idx);</a>
<a name="ln132"> </a>
<a name="ln133">        while (rt_flash_busy())</a>
<a name="ln134">        {</a>
<a name="ln135">            ri_yield();</a>
<a name="ln136">        }</a>
<a name="ln137">    }</a>
<a name="ln138"> </a>
<a name="ln139">    // It doesn't matter if there was no data to erase.</a>
<a name="ln140">    err_code &amp;= ~RD_ERROR_NOT_FOUND;</a>
<a name="ln141">    err_code |= rt_flash_gc_run ();</a>
<a name="ln142">    return err_code;</a>
<a name="ln143">}</a>
<a name="ln144"> </a>
<a name="ln145">#ifndef CEEDLING</a>
<a name="ln146">static</a>
<a name="ln147">#endif</a>
<a name="ln148">rd_status_t app_log_read_boot_count (void)</a>
<a name="ln149">{</a>
<a name="ln150">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln151">    err_code |= rt_flash_load (APP_FLASH_LOG_FILE, APP_FLASH_LOG_BOOT_COUNTER_RECORD,</a>
<a name="ln152">                               &amp;m_boot_count, sizeof (uint32_t));</a>
<a name="ln153"> </a>
<a name="ln154">    if ( (RD_SUCCESS == err_code) || (RD_ERROR_NOT_FOUND == err_code))</a>
<a name="ln155">    {</a>
<a name="ln156">        m_boot_count++;</a>
<a name="ln157">        err_code = rt_flash_store (APP_FLASH_LOG_FILE, APP_FLASH_LOG_BOOT_COUNTER_RECORD,</a>
<a name="ln158">                                   &amp;m_boot_count, sizeof (uint32_t));</a>
<a name="ln159">    }</a>
<a name="ln160"> </a>
<a name="ln161">    char msg[128];</a>
<a name="ln162">    snprintf (msg, sizeof (msg), &quot;LOG: Boot count: %d\r\n&quot;, m_boot_count);</a>
<a name="ln163">    LOG (msg);</a>
<a name="ln164">    return err_code;</a>
<a name="ln165">}</a>
<a name="ln166"> </a>
<a name="ln167"> </a>
<a name="ln168">rd_status_t app_log_init (void)</a>
<a name="ln169">{</a>
<a name="ln170">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln171">    // Defaults get overwritten by flash load and stored if the load fails.</a>
<a name="ln172">    app_log_config_t config =</a>
<a name="ln173">    {</a>
<a name="ln174">        .interval_s = APP_LOG_INTERVAL_S,</a>
<a name="ln175">        .overflow   = APP_LOG_OVERFLOW,</a>
<a name="ln176">        .fields = {</a>
<a name="ln177">            .datas.temperature_c = APP_LOG_TEMPERATURE_ENABLED,</a>
<a name="ln178">            .datas.humidity_rh = APP_LOG_HUMIDITY_ENABLED,</a>
<a name="ln179">            .datas.pressure_pa = APP_LOG_PRESSURE_ENABLED</a>
<a name="ln180">        }</a>
<a name="ln181">    };</a>
<a name="ln182">#   if APP_FLASH_LOG_CONFIG_NVM_ENABLED</a>
<a name="ln183">    err_code = rt_flash_load (APP_FLASH_LOG_FILE,</a>
<a name="ln184">                              APP_FLASH_LOG_CONFIG_RECORD,</a>
<a name="ln185">                              &amp;config, sizeof (config));</a>
<a name="ln186">#   endif</a>
<a name="ln187"> </a>
<a name="ln188">    if (RD_ERROR_NOT_FOUND == err_code) //-V547</a>
<a name="ln189">    {</a>
<a name="ln190">        err_code = rt_flash_store (APP_FLASH_LOG_FILE,</a>
<a name="ln191">                                   APP_FLASH_LOG_CONFIG_RECORD,</a>
<a name="ln192">                                   &amp;config, sizeof (config));</a>
<a name="ln193">    }</a>
<a name="ln194"> </a>
<a name="ln195">    if (RD_SUCCESS == err_code) //-V547</a>
<a name="ln196">    {</a>
<a name="ln197">        memcpy (&amp;m_log_config, &amp;config, sizeof (config));</a>
<a name="ln198">        err_code |= purge_logs();</a>
<a name="ln199">    }</a>
<a name="ln200"> </a>
<a name="ln201">    err_code |= app_log_read_boot_count();</a>
<a name="ln202">    return err_code;</a>
<a name="ln203">}</a>
<a name="ln204"> </a>
<a name="ln205">rd_status_t app_log_process (const rd_sensor_data_t * const sample)</a>
<a name="ln206">{</a>
<a name="ln207">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln208">    uint64_t next_sample_ms = m_last_sample_ms + (m_log_config.interval_s * 1000U);</a>
<a name="ln209">    uint32_t end_timestamp = m_log_input_block.end_timestamp_s;</a>
<a name="ln210">    LOGD (&quot;LOG: Sample received\r\n&quot;);</a>
<a name="ln211"> </a>
<a name="ln212">    // Always store first sample.</a>
<a name="ln213">    if (0 == m_last_sample_ms)</a>
<a name="ln214">    {</a>
<a name="ln215">        next_sample_ms = 0;</a>
<a name="ln216">    }</a>
<a name="ln217"> </a>
<a name="ln218">    //Check if new sample should be processed</a>
<a name="ln219">    if (next_sample_ms &lt;= sample-&gt;timestamp_ms)</a>
<a name="ln220">    {</a>
<a name="ln221">        LOGD (&quot;LOG: Storing sample\r\n&quot;);</a>
<a name="ln222">        app_log_element_t element =</a>
<a name="ln223">        {</a>
<a name="ln224">            .timestamp_s = sample-&gt;timestamp_ms / 1000U,</a>
<a name="ln225">            .temperature_c = rd_sensor_data_parse (sample, RD_SENSOR_TEMP_FIELD),</a>
<a name="ln226">            .humidity_rh = rd_sensor_data_parse (sample, RD_SENSOR_HUMI_FIELD),</a>
<a name="ln227">            .pressure_pa = rd_sensor_data_parse (sample, RD_SENSOR_PRES_FIELD),</a>
<a name="ln228">        };</a>
<a name="ln229"> </a>
<a name="ln230">        if (APP_LOG_MAX_SAMPLES &gt; m_log_input_block.num_samples)</a>
<a name="ln231">        {</a>
<a name="ln232">            m_log_input_block.storage[m_log_input_block.num_samples++] = element;</a>
<a name="ln233">        }</a>
<a name="ln234"> </a>
<a name="ln235">        if (m_log_input_block.num_samples &gt;= APP_LOG_MAX_SAMPLES)</a>
<a name="ln236">        {</a>
<a name="ln237">            LOG (&quot;LOG: Storing block\r\n&quot;);</a>
<a name="ln238">            err_code |= store_block (&amp;m_log_input_block);</a>
<a name="ln239">            RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln240">            memset (&amp;m_log_input_block, 0, sizeof (m_log_input_block));</a>
<a name="ln241">            m_log_input_block.start_timestamp_s = end_timestamp;</a>
<a name="ln242">        }</a>
<a name="ln243"> </a>
<a name="ln244">        m_last_sample_ms = sample-&gt;timestamp_ms;</a>
<a name="ln245">        m_log_input_block.end_timestamp_s = sample-&gt;timestamp_ms / 1000U;</a>
<a name="ln246">    }</a>
<a name="ln247">    else</a>
<a name="ln248">    {</a>
<a name="ln249">        // No action needed.</a>
<a name="ln250">    }</a>
<a name="ln251"> </a>
<a name="ln252">    return err_code;</a>
<a name="ln253">}</a>
<a name="ln254"> </a>
<a name="ln255">/**</a>
<a name="ln256"> * @brief Load new block to be read if needed.</a>
<a name="ln257"> *</a>
<a name="ln258"> * Can also copy input block to</a>
<a name="ln259"> * output block if there's no more stored blocks in flash.</a>
<a name="ln260"> */</a>
<a name="ln261">static rd_status_t app_log_read_load_block (app_log_read_state_t * const p_rs)</a>
<a name="ln262">{</a>
<a name="ln263">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln264"> </a>
<a name="ln265">    if ( (0 == p_rs-&gt;element_idx)</a>
<a name="ln266">            &amp;&amp; (0 == p_rs-&gt;page_idx))</a>
<a name="ln267">    {</a>
<a name="ln268">        // Clear out previous state</a>
<a name="ln269">        err_code |= rt_flash_load (APP_FLASH_LOG_FILE,</a>
<a name="ln270">                                   (APP_FLASH_LOG_DATA_RECORD_PREFIX &lt;&lt; 8U) + p_rs-&gt;page_idx,</a>
<a name="ln271">                                   &amp;m_log_output_block, sizeof (m_log_output_block));</a>
<a name="ln272">        p_rs-&gt;page_idx++;</a>
<a name="ln273">    }</a>
<a name="ln274">    else if ( (APP_FLASH_LOG_DATA_RECORDS_NUM &gt; p_rs-&gt;page_idx)</a>
<a name="ln275">              &amp;&amp; (p_rs-&gt;element_idx &gt;= m_log_output_block.num_samples))</a>
<a name="ln276">    {</a>
<a name="ln277">        // Returns NOT_FOUND if page IDX is not in flash.</a>
<a name="ln278">        err_code |= rt_flash_load (APP_FLASH_LOG_FILE,</a>
<a name="ln279">                                   (APP_FLASH_LOG_DATA_RECORD_PREFIX &lt;&lt; 8U) + p_rs-&gt;page_idx,</a>
<a name="ln280">                                   &amp;m_log_output_block, sizeof (m_log_output_block));</a>
<a name="ln281">        p_rs-&gt;page_idx++;</a>
<a name="ln282">        p_rs-&gt;element_idx = 0;</a>
<a name="ln283">    }</a>
<a name="ln284">    else if ( (APP_FLASH_LOG_DATA_RECORDS_NUM == p_rs-&gt;page_idx)</a>
<a name="ln285">              &amp;&amp; (p_rs-&gt;element_idx &gt;= m_log_output_block.num_samples))</a>
<a name="ln286">    {</a>
<a name="ln287">        memcpy (&amp;m_log_output_block, &amp;m_log_input_block, sizeof (m_log_output_block));</a>
<a name="ln288">        p_rs-&gt;page_idx++;</a>
<a name="ln289">        p_rs-&gt;element_idx = 0;</a>
<a name="ln290">    }</a>
<a name="ln291">    else</a>
<a name="ln292">    {</a>
<a name="ln293">        // No action needed.</a>
<a name="ln294">    }</a>
<a name="ln295"> </a>
<a name="ln296">    // Clear out state if block was not found</a>
<a name="ln297">    if (RD_ERROR_NOT_FOUND == err_code)</a>
<a name="ln298">    {</a>
<a name="ln299">        memset (&amp;m_log_output_block, 0, sizeof (m_log_output_block));</a>
<a name="ln300">    }</a>
<a name="ln301"> </a>
<a name="ln302">    return err_code;</a>
<a name="ln303">}</a>
<a name="ln304"> </a>
<a name="ln305">/**</a>
<a name="ln306"> * @brief Forward read state to first next valid element.</a>
<a name="ln307"> *</a>
<a name="ln308"> * @retval RD_SUCCESS p_rs points to a valid element</a>
<a name="ln309"> * @retval RD_ERROR_NOT_FOUND if block doesn't have a valid element.</a>
<a name="ln310"> */</a>
<a name="ln311">static rd_status_t app_log_read_fast_forward (app_log_read_state_t * const p_rs)</a>
<a name="ln312">{</a>
<a name="ln313">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln314">    uint64_t ts = m_log_output_block.storage[p_rs-&gt;element_idx].timestamp_s * 1000U;</a>
<a name="ln315"> </a>
<a name="ln316">    while ( (p_rs-&gt;oldest_element_ms &gt; ts)</a>
<a name="ln317">            &amp;&amp; (p_rs-&gt;element_idx &lt; m_log_output_block.num_samples))</a>
<a name="ln318">    {</a>
<a name="ln319">        ts = m_log_output_block.storage[p_rs-&gt;element_idx].timestamp_s * 1000U;</a>
<a name="ln320">        p_rs-&gt;element_idx++;</a>
<a name="ln321">    }</a>
<a name="ln322"> </a>
<a name="ln323">    if (p_rs-&gt;element_idx &gt;= m_log_output_block.num_samples)</a>
<a name="ln324">    {</a>
<a name="ln325">        err_code |= RD_ERROR_NOT_FOUND;</a>
<a name="ln326">    }</a>
<a name="ln327"> </a>
<a name="ln328">    return err_code;</a>
<a name="ln329">}</a>
<a name="ln330"> </a>
<a name="ln331">static rd_status_t app_log_read_populate (rd_sensor_data_t * const sample,</a>
<a name="ln332">        app_log_read_state_t * const p_rs)</a>
<a name="ln333">{</a>
<a name="ln334">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln335"> </a>
<a name="ln336">    // Last memory block is the current RAM buffer, so we have valid data</a>
<a name="ln337">    // when APP_FLASH_LOG_DATA_RECORDS_NUM + 1 == p_rs-&gt;page_idx</a>
<a name="ln338">    if ( (APP_FLASH_LOG_DATA_RECORDS_NUM + 1) &lt; p_rs-&gt;page_idx)</a>
<a name="ln339">    {</a>
<a name="ln340">        err_code |= RD_ERROR_NOT_FOUND;</a>
<a name="ln341">    }</a>
<a name="ln342">    else if (p_rs-&gt;element_idx &lt; m_log_output_block.num_samples)</a>
<a name="ln343">    {</a>
<a name="ln344">        const app_log_element_t * const p_el = &amp;m_log_output_block.storage[p_rs-&gt;element_idx];</a>
<a name="ln345">        rd_sensor_data_set (sample, RD_SENSOR_TEMP_FIELD, p_el-&gt;temperature_c);</a>
<a name="ln346">        rd_sensor_data_set (sample, RD_SENSOR_HUMI_FIELD, p_el-&gt;humidity_rh);</a>
<a name="ln347">        rd_sensor_data_set (sample, RD_SENSOR_PRES_FIELD, p_el-&gt;pressure_pa);</a>
<a name="ln348">        sample-&gt;timestamp_ms = (uint64_t) (p_el-&gt;timestamp_s) * 1000U;</a>
<a name="ln349">        p_rs-&gt;element_idx++;</a>
<a name="ln350">    }</a>
<a name="ln351">    else</a>
<a name="ln352">    {</a>
<a name="ln353">        // No action required.</a>
<a name="ln354">    }</a>
<a name="ln355"> </a>
<a name="ln356">    return err_code;</a>
<a name="ln357">}</a>
<a name="ln358"> </a>
<a name="ln359">rd_status_t app_log_read (rd_sensor_data_t * const sample,</a>
<a name="ln360">                          app_log_read_state_t * const p_rs)</a>
<a name="ln361">{</a>
<a name="ln362">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln363"> </a>
<a name="ln364">    if ( (NULL != sample) &amp;&amp; (NULL != p_rs))</a>
<a name="ln365">    {</a>
<a name="ln366">        // Load new block if needed</a>
<a name="ln367">        do</a>
<a name="ln368">        {</a>
<a name="ln369">            err_code = app_log_read_load_block (p_rs);</a>
<a name="ln370"> </a>
<a name="ln371">            // Decompress block -todo.</a>
<a name="ln372">            // Check if ths block contains data in desired time range - TODO</a>
<a name="ln373">            // Fast forward to start of desired time range.</a>
<a name="ln374">            if (RD_SUCCESS == err_code)</a>
<a name="ln375">            {</a>
<a name="ln376">                err_code |= app_log_read_fast_forward (p_rs);</a>
<a name="ln377">            }</a>
<a name="ln378">        } while ( (err_code != RD_SUCCESS)</a>
<a name="ln379"> </a>
<a name="ln380">                  &amp;&amp; (p_rs-&gt;page_idx &lt;= APP_FLASH_LOG_DATA_RECORDS_NUM));</a>
<a name="ln381"> </a>
<a name="ln382">        // AStyle fails here. ^</a>
<a name="ln383">        // Populate record</a>
<a name="ln384">        err_code |= app_log_read_populate (sample, p_rs);</a>
<a name="ln385">    }</a>
<a name="ln386">    else</a>
<a name="ln387">    {</a>
<a name="ln388">        err_code = RD_ERROR_NULL;</a>
<a name="ln389">    }</a>
<a name="ln390"> </a>
<a name="ln391">    return err_code;</a>
<a name="ln392">}</a>
<a name="ln393"> </a>
<a name="ln394">rd_status_t app_log_config_set (const app_log_config_t * const configuration)</a>
<a name="ln395">{</a>
<a name="ln396">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln397">    uint32_t end_timestamp = m_log_input_block.end_timestamp_s;</a>
<a name="ln398"> </a>
<a name="ln399">    if (NULL == configuration)</a>
<a name="ln400">    {</a>
<a name="ln401">        err_code |= RD_ERROR_NULL;</a>
<a name="ln402">    }</a>
<a name="ln403">    else</a>
<a name="ln404">    {</a>
<a name="ln405">        err_code |= rt_flash_store (APP_FLASH_LOG_FILE,</a>
<a name="ln406">                                    APP_FLASH_LOG_CONFIG_RECORD,</a>
<a name="ln407">                                    &amp;configuration, sizeof (configuration));</a>
<a name="ln408"> </a>
<a name="ln409">        if (RD_SUCCESS == err_code)</a>
<a name="ln410">        {</a>
<a name="ln411">            err_code |= store_block (&amp;m_log_input_block);</a>
<a name="ln412">            RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln413">            memset (&amp;m_log_input_block, 0, sizeof (m_log_input_block));</a>
<a name="ln414">            m_log_input_block.start_timestamp_s = end_timestamp;</a>
<a name="ln415">            memcpy (&amp;m_log_config, configuration, sizeof (m_log_config));</a>
<a name="ln416">        }</a>
<a name="ln417">    }</a>
<a name="ln418"> </a>
<a name="ln419">    return err_code;</a>
<a name="ln420">}</a>
<a name="ln421"> </a>
<a name="ln422">rd_status_t app_log_config_get (app_log_config_t * const configuration)</a>
<a name="ln423">{</a>
<a name="ln424">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln425">    err_code |= rt_flash_load (APP_FLASH_LOG_FILE,</a>
<a name="ln426">                               APP_FLASH_LOG_CONFIG_RECORD,</a>
<a name="ln427">                               configuration, sizeof (app_log_config_t));</a>
<a name="ln428">    memcpy (configuration, &amp;m_log_config, sizeof (m_log_config));</a>
<a name="ln429">    return err_code;</a>
<a name="ln430">}</a>
<a name="ln431"> </a>
<a name="ln432">void app_log_purge_flash (void)</a>
<a name="ln433">{</a>
<a name="ln434">    ri_flash_purge();</a>
<a name="ln435">}</a>
<a name="ln436"> </a>
<a name="ln437">#else</a>
<a name="ln438">//Dummy implementation to save flash space</a>
<a name="ln439">rd_status_t app_log_init (void)</a>
<a name="ln440">{</a>
<a name="ln441">    return RD_SUCCESS;</a>
<a name="ln442">}</a>
<a name="ln443">rd_status_t app_log_process (const rd_sensor_data_t * const sample)</a>
<a name="ln444">{</a>
<a name="ln445">    return RD_SUCCESS;</a>
<a name="ln446">}</a>
<a name="ln447">rd_status_t app_log_config_get (app_log_config_t * const configuration)</a>
<a name="ln448">{</a>
<a name="ln449">    return RD_SUCCESS;</a>
<a name="ln450">}</a>
<a name="ln451">rd_status_t app_log_config_set (const app_log_config_t * const configuration)</a>
<a name="ln452">{</a>
<a name="ln453">    return RD_SUCCESS;</a>
<a name="ln454">}</a>
<a name="ln455">rd_status_t app_log_read (rd_sensor_data_t * const sample,</a>
<a name="ln456">                          app_log_read_state_t * const p_read_state)</a>
<a name="ln457">{</a>
<a name="ln458">    return RD_ERROR_NOT_FOUND;</a>
<a name="ln459">}</a>
<a name="ln460"> </a>
<a name="ln461">void app_log_purge_flash (void)</a>
<a name="ln462">{</a>
<a name="ln463">    return;</a>
<a name="ln464">}</a>
<a name="ln465">#endif</a>

</code></pre>
<div class="balloon" rel="68"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '%' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="68"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(record_idx + num_tries) % ((16U) - 2U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="69"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '((0xF0U) << 8U) + record_slot' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="70"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xF0U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="76"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2600/" target="_blank">V2600</a> The function with the 'snprintf' name should not be used.</p></div>
<div class="balloon" rel="82"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2600/" target="_blank">V2600</a> The function with the 'snprintf' name should not be used.</p></div>
<div class="balloon" rel="100"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xF0U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="102"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the 'sizeof (app_log_record_t)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="117"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the 'record_idx % ((16U) - 2U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="130"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xF0U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="131"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '((0xF0U) << 8U) + record_idx' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="151"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xF0U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="151"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xEFU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="157"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xF0U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="157"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xEFU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="162"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2600/" target="_blank">V2600</a> The function with the 'snprintf' name should not be used.</p></div>
<div class="balloon" rel="188"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2594/" target="_blank">V2594</a> Controlling expressions should not be invariant. The result of the '(1U << 2U) == err_code' expression in the 'if' statement is always false.</p></div>
<div class="balloon" rel="190"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xF0U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="191"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0x01U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="195"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2594/" target="_blank">V2594</a> Controlling expressions should not be invariant. The result of the '(0U) == err_code' expression in the 'if' statement is always true.</p></div>
<div class="balloon" rel="213"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '==' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="215"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="230"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '-' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="235"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '-' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="245"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the 'sample->timestamp_ms / 1000U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="265"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '==' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="266"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '==' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="269"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xF0U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="270"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '((0xF0U) << 8U) + p_rs->page_idx' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="278"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xF0U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="279"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '((0xF0U) << 8U) + p_rs->page_idx' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="282"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="289"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="314"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2596/" target="_blank">V2596</a> Value of composite expression should not be assigned to object of wider essential type. Inspect the expression of the 'unsigned int' type that is assigned to the 'ts' variable of the 'unsigned long long' type.</p></div>
<div class="balloon" rel="319"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2596/" target="_blank">V2596</a> Value of composite expression should not be assigned to object of wider essential type. Inspect the expression of the 'unsigned int' type that is assigned to the 'ts' variable of the 'unsigned long long' type.</p></div>
<div class="balloon" rel="338"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '+' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="405"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xF0U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="406"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0x01U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="425"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0xF0U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="426"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '(0x01U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
